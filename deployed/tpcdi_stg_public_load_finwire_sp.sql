-- Databricks notebook source
-- Has an automation defect. Will be updated after the fix
create or refresh streaming live table public_finwire_stg
(PTS STRING NOT NULL COMMENT 'POSTING DATE & TIME AS YYYYMMDD-HHMMSS - FIN, CMP, SEC', 
 REC_TYPE STRING NOT NULL COMMENT '“FIN”, "CMP", OR "SEC" - FIN, CMP, SEC', 
 COMPANY_NAME STRING NOT NULL COMMENT 'NAME OF THE COMPANY - CMP',
 CIK STRING NOT NULL COMMENT 'COMPANY IDENTIFICATION CODE FROM SEC - CMP',
 STATUS STRING NOT NULL COMMENT 'ACTV FOR ACTIVE COMPANY, INAC FOR INACTIVE - CMP, SEC',
 INDUSTRY_ID STRING NOT NULL COMMENT 'CODE FOR INDUSTRY SEGMENT - CMP',
 SP_RATING STRING NOT NULL COMMENT 'S&P RATING - CMP',
 FOUNDING_DATE STRING COMMENT 'A DATE AS YYYYMMDD - CMP',
 ADDR_LINE1 STRING NOT NULL COMMENT 'MAILING ADDRESS - CMP',
 ADDR_LINE2 STRING COMMENT 'MAILING ADDRESS - CMP',
 POSTAL_CODE STRING NOT NULL COMMENT 'MAILING ADDRESS - CMP',
 CITY STRING NOT NULL COMMENT 'MAILING ADDRESS - CMP',
 STATE_PROVINCE STRING NOT NULL COMMENT 'MAILING ADDRESS - CMP',
 COUNTRY STRING COMMENT 'MAILING ADDRESS - CMP',
 CEO_NAME STRING NOT NULL COMMENT 'NAME OF COMPANY CEO - CMP',
 DESCRIPTION STRING NOT NULL COMMENT 'DESCRIPTION OF THE COMPANY - CMP',
 YEAR STRING NOT NULL COMMENT 'YEAR OF THE QUARTER END. - FIN',
 QUARTER STRING NOT NULL COMMENT 'QUARTER NUMBER: VALID VALUES ARE 1, 2, 3, 4 - FIN', 
 QTR_START_DATE STRING NOT NULL COMMENT 'START DATE OF QUARTER, AS YYYYMMDD - FIN',
 POSTING_DATE STRING NOT NULL COMMENT 'POSTING DATE OF QUARTERLY REPORT AS YYYYMMDD - FIN', 
 REVENUE STRING NOT NULL COMMENT 'REPORTED REVENUE FOR THE QUARTER - FIN', 
 EARNINGS STRING NOT NULL COMMENT 'NET EARNINGS REPORTED FOR THE QUARTER - FIN', 
 EPS STRING NOT NULL COMMENT 'BASIC EARNINGS PER SHARE FOR THE QUARTER - FIN', 
 DILUTED_EPS STRING NOT NULL COMMENT 'DILUTED EARNINGS PER SHARE FOR THE QUARTER - FIN', 
 MARGIN STRING NOT NULL COMMENT 'PROFIT DIVIDED BY REVENUES FOR THE QUARTER - FIN', 
 INVENTORY STRING NOT NULL COMMENT 'VALUE OF INVENTORY ON HAND AT END OF QUARTER - FIN', 
 ASSETS STRING NOT NULL COMMENT 'VALUE OF TOTAL ASSETS AT THE END OF QUARTER - FIN', 
 LIABILITIES STRING NOT NULL COMMENT 'VALUE OF TOTAL LIABILITIES AT THE END OF QUARTER - FIN', 
 SH_OUT STRING NOT NULL COMMENT 'AVERAGE NUMBER OF SHARES OUTSTANDING - FIN, SEC', 
 DILUTED_SH_OUT STRING NOT NULL COMMENT 'AVERAGE NUMBER OF SHARES OUTSTANDING (DILUTED) - FIN', 
 CO_NAME_OR_CIK STRING NOT NULL COMMENT 'COMPANY CIK NUMBER (IF ONLY DIGITS, 10 VARCHARS) OR NAME (IF NOT ONLY DIGITS, 60 VARCHARS) - FIN, SEC', 
 SYMBOL STRING NOT NULL COMMENT 'SECURITY SYMBOL - SEC', 
 ISSUE_TYPE STRING NOT NULL COMMENT 'ISSUE TYPE - SEC', 
 NAME STRING NOT NULL COMMENT 'SECURITY NAME - SEC', 
 EX_ID STRING NOT NULL COMMENT 'ID OF THE EXCHANGE THE SECURITY IS TRADED ON - SEC', 
 FIRST_TRADE_DATE STRING NOT NULL COMMENT 'DATE OF FIRST TRADE AS YYYYMMDD - SEC', 
 FIRST_TRADE_EXCHG STRING NOT NULL COMMENT 'DATE OF FIRST TRADE ON EXCHANGE AS YYYYMMDD - SEC', 
 DIVIDEND STRING NOT NULL COMMENT 'DIVIDEND AS VALUE_T - SEC')
using delta 
as select
 SUBSTR ( $1, 0, 15 ) PTS, 
 SUBSTR ( $1, 16, 3 ) REC_TYPE, 
 SUBSTR ( $1, 19, 60 ) COMPANY_NAME, 
 SUBSTR ( $1, 79, 10 ) CIK, 
 IFF ( SUBSTR ( $1, 16, 3 ) = ' CMP', SUBSTR ( $1, 89, 4 ), SUBSTR ( $1, 40, 4 ) ) STATUS,
 SUBSTR ( $1, 93, 2 ) INDUSTRY_ID, 
 SUBSTR ( $1, 95, 4 ) SP_RATING,
 SUBSTR ( $1, 99, 8 ) FOUNDING_DATE, 
 SUBSTR ( $1, 107, 80 ) ADDR_LINE1,
 SUBSTR ( $1, 187, 80 ) ADDR_LINE2, 
 SUBSTR ( $1, 267, 12 ) POSTAL_CODE,
 SUBSTR ( $1, 279, 25 ) CITY, 
 SUBSTR ( $1, 304, 20 ) STATE_PROVINCE,
 SUBSTR ( $1, 324, 24 ) COUNTRY, 
 SUBSTR ( $1, 348, 46 ) CEO_NAME, 
 SUBSTR ( $1, 394, 150 ) DESCRIPTION, 
 SUBSTR ( $1, 19, 4 ) YEAR, 
 SUBSTR ( $1, 23, 1 ) QUARTER, 
 SUBSTR ( $1, 24, 8 ) QTR_START_DATE, 
 SUBSTR ( $1, 32, 8 ) POSTING_DATE, 
 SUBSTR ( $1, 40, 17 ) REVENUE, 
 SUBSTR ( $1, 57, 17 ) EARNINGS, 
 SUBSTR ( $1, 74, 12 ) EPS, 
 SUBSTR ( $1, 86, 12 ) DILUTED_EPS,
 SUBSTR ( $1, 98, 12 ) MARGIN, 
 SUBSTR ( $1, 110, 17 ) INVENTORY, 
 SUBSTR ( $1, 127, 17 ) ASSETS, 
 SUBSTR ( $1, 144, 17 ) LIABILITIES, 
 IFF ( SUBSTR ( $1, 16, 3 ) = 'FIN', SUBSTR ( $1, 161, 13 ), SUBSTR ( $1, 120, 13 ) ) SH_OUT,
 SUBSTR ( $1, 174, 13 ) DILUTED_SH_OUT, 
 IFF ( SUBSTR ( $1, 16, 3 ) = 'FIN', SUBSTR ( $1, 187, 60 ), SUBSTR ( $1, 161, 60 ) ) CO_NAME_OR_CIK, 
 SUBSTR ( $1, 19, 15 ) SYMBOL, 
 SUBSTR ( $1, 34, 6 ) ISSUE_TYPE, 
 SUBSTR ( $1, 44, 70 ) NAME,
 SUBSTR ( $1, 114, 6 ) EX_ID, 
 SUBSTR ( $1, 133, 8 ) FIRST_TRADE_DATE,
 SUBSTR ( $1, 141, 8 ) FIRST_TRADE_EXCHG, 
 SUBSTR ( $1, 149, 12 ) DIVIDEND
from cloud_files(
                 "s3://tpcdi-files/tmp/tpcdi/sf=${tpcdi_scale}/Batch${batch_counter}/FINWIRE",
                 "csv",
                 map("inferSchema", "False", 
                     
                     "header", "False",
                     "delimiter", "NONE")
                )
